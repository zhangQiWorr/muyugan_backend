# 播放记录更新、有效观看时长计算和完成率判断逻辑文档

## 概述

本文档详细说明了视频播放系统中播放记录更新、有效观看时长计算和完成率判断的逻辑与公式。

## 核心概念

### 1. 播放记录 (MediaPlayRecord)
记录用户对特定媒体文件的播放行为和统计数据，包括：
- 播放进度信息
- 有效观看时长
- 播放状态
- 播放行为统计
- 完成状态

### 2. 播放事件 (MediaPlayEvent)
记录用户播放过程中的每个具体事件，包括：
- 播放开始/暂停/结束
- 进度拖动
- 心跳事件
- 播放设置变更

## 播放记录更新逻辑

### 1. 播放记录创建和获取

```python
def get_or_create_play_record(self, user_id: str, media_id: str) -> MediaPlayRecord:
    """
    获取或创建播放记录
    - 如果记录存在，直接返回
    - 如果不存在，创建新记录并设置首次播放时间
    """
```

### 2. 播放事件处理流程

```python
def process_play_event(self, user_id, media_id, event_type, current_time, ...):
    """
    处理播放事件的完整流程：
    1. 获取或创建播放记录
    2. 创建播放事件记录
    3. 更新播放记录基本信息
    4. 更新播放状态
    5. 计算播放进度
    6. 更新有效播放时长
    7. 检查并标记完成状态
    8. 提交数据库事务
    """
```

### 3. 播放状态更新

| 事件类型 | 状态更新 | 统计更新 |
|---------|---------|---------|
| play | is_playing=True, is_paused=False | play_count += 1 |
| pause | is_playing=False, is_paused=True | - |
| seek | - | seek_count += 1 |
| ended | is_playing=False, is_ended=True | - |

## 有效观看时长计算逻辑

### 1. 计算公式

```
有效观看时长 = Σ(时间差 / 播放速度)
```

其中：
- 时间差 = 当前时间 - 上一个播放时间点
- 播放速度 = max(playback_rate, 0.25) （防止除零和异常值）

### 2. 计算条件

有效观看时长只在以下情况下计算：

#### 2.1 支持的事件类型
- `pause`：暂停事件
- `ended`：播放结束事件  
- `heartbeat`：心跳事件（定期上报）

#### 2.2 时间差验证
- 最小时间差：0.1秒
- 最大时间差：120秒
- 超出范围的时间差将被忽略

#### 2.3 时间点获取逻辑
1. **优先使用previous_time**：如果调用时提供了previous_time参数
2. **查询最近事件**：如果没有previous_time，查询最近的PLAY或HEARTBEAT事件
3. **跳过计算**：如果无法获取有效的时间点，跳过本次计算

### 3. 特殊情况处理

#### 3.1 播放开始事件 (play)
- 记录播放开始时间
- 不计入有效观看时长
- 为后续计算做准备

#### 3.2 拖动事件 (seek)
- 不计入有效观看时长
- 重置播放时间基准点
- 增加拖动次数统计

#### 3.3 播放速度影响
- 播放速度 > 1.0：实际观看时长 = 时间差 / 播放速度
- 播放速度 ≤ 0.25：使用最小值0.25防止异常

## 完成率判断逻辑

### 1. 完成率计算公式

```
完成率 = min(最大播放时间 / 视频总时长, 1.0)
```

### 2. 有效完成判断条件

用户观看被标记为"有效完成"需要同时满足：

1. **播放完成率 ≥ 90%**：`completion_rate >= 0.9`
2. **有效观看率 ≥ 调整后的要求**：`effective_rate >= adjusted_effective_rate`

其中：
```
有效观看率 = 有效观看时长 / 视频总时长
```

#### 2.1 动态调整有效观看率要求

根据用户的拖动行为动态调整有效观看率要求：

| 拖动次数 | 调整规则 | 实际要求 |
|---------|---------|---------|
| ≤ 10次 | 无调整 | 80% |
| 11-20次 | 降低15% | 68% |
| > 20次 | 降低30% | 56% |

**调整逻辑**：
- 拖动次数较少：说明用户正常观看，保持标准要求
- 拖动次数较多：用户可能在寻找特定内容，适当降低要求
- 拖动次数过多：用户可能在快速浏览，大幅降低要求

**示例**：
- 标准要求：有效观看率 ≥ 80%
- 拖动15次：有效观看率 ≥ 68% (80% × 0.85)
- 拖动25次：有效观看率 ≥ 56% (80% × 0.7)

### 3. 完成状态检查时机

- 播放结束事件 (`ended`)
- 播放进度达到90%时

## 数据模型字段说明

### MediaPlayRecord 关键字段

| 字段名 | 类型 | 说明 |
|-------|------|------|
| current_time | Float | 当前播放时间点（秒） |
| max_played_time | Float | 最大播放到的时间点（秒） |
| progress | Float | 播放进度百分比 (0.0-1.0) |
| effective_duration | Float | 有效观看时长（秒） |
| total_play_time | Float | 总播放时间（包含重复播放） |
| play_count | Integer | 播放次数 |
| seek_count | Integer | 拖动次数 |
| completed | Boolean | 是否完成观看 |
| playback_rate | Float | 播放速度 |

### MediaPlayEvent 关键字段

| 字段名 | 类型 | 说明 |
|-------|------|------|
| event_type | Enum | 事件类型 |
| current_time | Float | 事件发生时的播放时间点 |
| previous_time | Float | 上一个时间点（用于seek事件） |
| playback_rate | Float | 播放速度 |
| timestamp | DateTime | 事件发生时间 |

## API 接口说明

### 播放事件上报接口

**POST** `/api/media/report`

```json
{
    "user_id": "用户ID",
    "media_id": "媒体ID", 
    "event_type": "事件类型",
    "current_time": 120.5,
    "previous_time": 115.0,
    "playback_rate": 1.0,
    "volume": 0.8,
    "is_fullscreen": false
}
```

**响应示例**：
```json
{
    "success": true,
    "message": "播放事件上报成功",
    "data": {
        "record_id": "记录ID",
        "event_id": "事件ID", 
        "current_time": 120.5,
        "progress": 0.33,
        "completion_rate": 0.33,
        "effective_play_time": 105.2,
        "is_completed": false
    }
}
```

## 最佳实践建议

### 1. 前端调用建议

1. **定期发送心跳事件**：建议每10-30秒发送一次heartbeat事件
2. **提供previous_time**：在pause、ended、heartbeat事件中提供previous_time参数
3. **及时上报状态变化**：播放、暂停、拖动等状态变化应及时上报

### 2. 后端处理建议

1. **数据验证**：严格验证时间差的合理性
2. **异常处理**：对异常数据进行记录和过滤
3. **性能优化**：考虑对频繁的心跳事件进行批量处理

### 3. 监控指标

1. **有效观看时长**：监控用户的有效观看时长分布
2. **完成率**：监控视频的完成率统计
3. **异常行为**：监控异常拖动和播放行为

## 故障排查

### 1. 有效观看时长为空

**可能原因**：
- 前端未正确发送previous_time参数
- 事件类型不支持有效时长计算
- 时间差超出合理范围

**解决方案**：
- 检查前端事件上报逻辑
- 确保发送heartbeat事件
- 验证时间差计算逻辑

### 2. 完成率计算错误

**可能原因**：
- 视频时长获取失败
- 播放进度计算错误
- 数据库字段类型不匹配

**解决方案**：
- 检查视频时长数据
- 验证进度计算公式
- 确认数据库字段类型

## 更新日志

- **2024-01-XX**：修复有效观看时长为空的问题
- **2024-01-XX**：优化完成率判断逻辑
- **2024-01-XX**：添加异常行为检测
